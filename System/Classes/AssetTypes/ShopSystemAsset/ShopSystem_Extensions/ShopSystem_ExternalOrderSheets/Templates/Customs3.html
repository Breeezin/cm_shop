<?
	global $cfg;
	$row = $data['Q_OrderSheet']->fetchRow();
	$data = array_merge($data,$row);
	$checkboxes = array();
	$nocheckboxes = array();
	$wontcheckboxes = array();
	$trackcheckboxes = array();
?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Bjorck Bros. S.L.</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<tmpl_if condition="!array_key_exists('HideButtons',$data)">
<link href="Custom/ContentStore/Layouts/<?=$GLOBALS['cfg']['currentSiteFolder'];?>sty_mainPrint.css" rel="stylesheet" type="text/css" media="print">
</tmpl_if>
<style type="text/css">
.Bodytext,body,p,td,table {  font-family: Arial, Helvetica, sans-serif; font-size: 11px; color: #333333; text-decoration: none}
H1 {  
	font-family: Georgia, "Times New Roman", Times, serif;
	font-size: 14px;
	font-weight: bold;
	TEXT-DECORATION: none;
	color:#B44D00;
}
H3 {
	font-family: Georgia, "Times New Roman", Times, serif;
	font-size: 12px;
	font-weight: bold;
	color: #3E2116;
}
#categoryDescriptions p {  font-family: Arial, Helvetica, sans-serif; font-size: 10px; color: #87684E; text-decoration: none}
.footerText {  font-family: Arial, Helvetica, sans-serif; font-size: 10px; color: #87684E; text-decoration: none}
.footerText:hover {  font-family: Arial, Helvetica, sans-serif; font-size: 10px; color: #B44D00; text-decoration: none}
.AdminRequired { color: Red }
.AdminErrorField { background : LightSkyBlue; }
.AdminButtons { 	
	font-size: 8pt; 
	font-variant: small-caps; 
	background-color: Silver;
	padding-left:15px; 
	padding-right:15px; 
	border: thin outset white; 
	cursor: hand; 
	font-family: Arial, Helvetica, sans-serif; 
}
.AdminEvenRow { background : #EEEEEE; }
.AdminOddRow {  }
.BreadCrumbs {
	font-size: 10px;
	color: black;
	text-decoration: none;
}
.BreadCrumbs:hover {
	font-size: 10px;
	color: black;
	text-decoration: underline;
}
.dotline {
	background-image: url(Images/dotline.gif);
	background-repeat: repeat-x;
	background-position: center;
}
.Border {
	border: 1px solid #C9BFA7;
}
.CandyStripeHome {
	background-image: url(Images/candy-home.gif);
	background-repeat: repeat-y;
	background-position: right center;
	width: 237px;
}
.CandyStripeInside {
	background-image: url(Images/candy-inside.gif);
	background-repeat: repeat-y;
	background-position: right center;
	width: 136px;
}
.Copyright {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 10px;
	font-weight: bold;
	color: #D7CF7D;
	text-decoration: none;
	padding-bottom: 10px;
}
.Grungefill {
	background-image: url(Images/grunge-fill.gif);
	background-repeat: repeat-y;
	background-position: center;
	width: 387px;
}
A {
	COLOR: #CC6600; 
	text-decoration: underline;
}
.A_hover {
	COLOR: #333333; 
	text-decoration: underline;	
}
.textLight10 {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 10px;
	font-weight: bold;
	color: #D9CBAF;
	text-decoration: none;
	line-height: 17px;

}
.textLight11 {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 11px;
	font-weight: normal;
	color: #F7F5E5;
	text-decoration: none;
	line-height: 18px;

}
input, textarea,select {
	border-top-width: 1px;
	border-right-width: 1px;
	border-bottom-width: 1px;
	border-left-width: 1px;
	border-top-style: solid;
	border-right-style: solid;
	border-bottom-style: solid;
	border-left-style: solid;
	border-top-color: #AEAEAE;
	border-right-color: CCCCCC;
	border-bottom-color: CCCCCC;
	border-left-color: #AEAEAE;
	font-family: Arial, Helvetica, sans-serif;
	font-size: 10px;
	text-align: left;
	padding-left: 5px;
}
.EmailFormAssetSubmitButton {
	font-family: Verdana, Arial, Helvetica, sans-serif;
	color: FFFFFF;
	font-weight: bold;	
	font-size: 9px;
	background-color: A4B75D;
	border-top-width: 1px;
	border-right-width: 1px;
	border-bottom-width: 1px;
	border-left-width: 1px;
	border-top-style: solid;
	border-right-style: solid;
	border-bottom-style: solid;
	border-left-style: solid;
	border-top-color: ffffff;
	border-right-color: #ffffff;
	border-bottom-color: #ffffff;
	border-left-color: ffffff;
	padding-left: 5px;
	padding-right: 5px;	
	text-align: center;
}
.noBorder {
	background-color: transparent;
	border: 0px solid ;	
}

.textWelcome {
	font-family: Georgia, "Times New Roman", Times, serif;
	font-size: 11px;
	line-height: 17px;
	color: #CC6600;
	font-weight: normal;

}
.textSubHeaders {
	font-size: 11px;
	color: #3092A7;
	font-weight: bold;
}
.textSubHeaders {
	font-size: 10px;
	color: #87684E;
	font-weight: bold;
	font-family: Georgia, "Times New Roman", Times, serif;

}
strong {
	font-weight: bold;
}
.textNews {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 10px;
	font-weight: bold;
	color: #F7F5E5;
	text-decoration: none;
	BORDER-BOTTOM: 0px none;
}
.textNewsDate {

	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 9px;
	font-weight: bold;
	color: #F7F5E5;
	text-decoration: none;
}
.textNews:hover {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 10px;
	font-weight: bold;
	color: #F7F5E5;
	text-decoration: none;
	BORDER-BOTTOM: 0px none;
}
.textMed11 {

	font-family: Arial, Helvetica, sans-serif;
	font-size: 11px;
	font-weight: normal;
	color: #D9CBAF;
	text-decoration: none;
	line-height: 17px;
}.textMed11link {


	font-family: Arial, Helvetica, sans-serif;
	font-size: 11px;
	font-weight: normal;
	color: #D9CBAF;
	text-decoration: underline;
	line-height: 17px;
}
.Bannersml {
	background-image: url(Images/banner-sml.jpg);
	background-position: right top;
}
.Brownback {
	width: 387px;
	background-color: #3E2116;

}
.Line {
	border-top-width: 1px;
	border-bottom-width: 4px;
	border-top-style: solid;
	border-bottom-style: solid;
	border-top-color: #C9BFA7;
	border-bottom-color: #C9BFA7;

}
.LineTop {
	border-top-width: 4px;
	border-top-style: solid;
	border-top-color: #C9BFA7;

}
.LineBott {
	border-top-width: 7px;
	border-top-style: solid;
	border-top-color: #C9BFA7;

}
.textsideLinks {

	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 10px;
	font-weight: bold;
	color: #EDEBD5;
	text-decoration: none;
	line-height: 17px;
}
li {
	list-style-image: url(Images/bullet.gif);
		MARGIN-TOP: 8px;
	MARGIN-BOTTOM: 8px;
}.onlineShopSizeQuick {


	font-family: Arial, Helvetica, sans-serif;
	font-size: 11px;
	font-weight: normal;
	color:#C13129;
}.textHeader {
	font-family: Georgia, "Times New Roman", Times, serif;
	font-size: 12px;
	font-weight: bold;
	color: #B44D00;
}
.Sizename {
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 9px;
	font-weight: bold;
	color: #87684E;
	background-color: #D2CAB6;
	padding: 4px 4px 4px 8px;

}
.SizeBrands {
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 9px;
	font-weight: bold;
	color: #87684E;
	background-color: E9E5DC;
	padding: 4px;

}
.SizeDetails {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 10px;
	font-weight: bold;
	color: #7C5631;
	padding-right: 1px;
	padding-left: 1px;


}
.Size {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 10px;
	font-weight: bold;
	color: #7C5631;
	padding-top: 5px;
	padding-left: 5px;

}
.boxtopfill {
	background-image: url(Images/top.gif);
	background-repeat: repeat-x;


}
.boxleftfill {
	background-image: url(Images/left.gif);
	background-repeat: repeat-y;


}
.boxrightfill {
	background-image: url(Images/right.gif);
	background-repeat: repeat-y;


}
.boxbott {

	background-image: url(Images/bott1.gif);
	background-repeat: repeat-x;
}
.textQuotes {

	font-family: Georgia, "Times New Roman", Times, serif;
	font-size: 11px;
	line-height: 19px;
	color: #87684E;
	font-weight: normal;
}
.linevert {
	background-image: url(Images/line-vert.gif);
	background-repeat: repeat-y;
	background-position: center;
	width: 14px;
}
.onlineShopPriceQuick {

	border:  none;
	font-family: Arial, Helvetica, sans-serif;
	font-size: 11px;
	font-weight: bold;
	color: #3E2116;
}
.textFormsBold {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 11px;
	font-weight: bold;
	color: #333333;
	padding-right: 10px;
}
.Formbordertop {
	border-top-width: 1px;
	border-top-style: dotted;
	border-top-color: #CCCCCC;
	padding-bottom: 5px;
	padding-top: 5px;



}
.Formbordercenter {

	background-image: url(Images/line-vert.gif);
	background-repeat: repeat-y;
	background-position: center;
}
.textRed {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 10px;
	color: #C90000;
	text-decoration: none;

}
.bannerleft {
	background-image: url(Images/top-left.jpg);
	background-repeat: no-repeat;
	width: 32px;
	background-position: left top;

}
.bannerright {

	background-image: url(Images/top-right.jpg);
	background-repeat: no-repeat;
	background-position: left top;
	width: 31px;
}
.bannermiddle {
	background-image: url(Images/top-banner.jpg);
	background-repeat: no-repeat;
	background-position: center top;
	width: 687px;
	height: 92px;

}
.text14 {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 14px;
	font-weight: bold;
	color: #333333;
}
.text12 {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 12px;
	font-weight: bold;
	color: #333333;

}
.Borderinvoice {
	border: 1px solid #999999;

}
.text12Italic {

	font-family: Arial, Helvetica, sans-serif;
	font-size: 12px;
	font-weight: bold;
	color: #333333;
	font-style: italic;
}
.textNotes {

	font-family: Arial, Helvetica, sans-serif;
	font-size: 10px;
	color: #999999;
	text-decoration: none;
}
.Borderordersheet {
	background-color: #333333;
	font-family: Arial, Helvetica, sans-serif;
	font-size: 11px;
	font-weight: bold;
	color: #FFFFFF;
	background-position: center;
	text-align: center;



}
</style>
</head>
<?php

$trackingOption = getField( 'select ve_tracking from vendor where ve_id = '.$data['Vendor'] );

$title = '';
$distributors = array();
$distCountries = array();
if( $dq = query( 'select * from Users where us_vendor_distributor = '.$data['Vendor'] ) )
{
	while( $distributor = $dq->fetchRow( ) )
	{
		if( $data['Distributor'] == $distributor['us_id'] )
			$title = "<h2>Customs report for distributor {$distributor['us_first_name']} {$distributor['us_last_name']} {$distributor['us_0_50A1']} {$distributor['us_0_50A2']}  {$distributor['us_0_B4C0']}</h2>";

		$distributors[$distributor['us_id']] = array();
		$distributors[$distributor['us_id']]['Countries'] = array();
		$distributors[$distributor['us_id']]['OrderRows'] = array();
		$distributors[$distributor['us_id']]['OrderServices'] = array();
		$distributors[$distributor['us_id']]['User'] = $distributor;
		if( $dcn = query( "select cn_id from Countries where cn_ship_via_distributor = {$distributor['us_id']}" ) )
			while( $dcnrw = $dcn->fetchRow( $dcn ) )
			{
				$distributors[$distributor['us_id']]['Countries'][] = $dcnrw['cn_id'];
				$distCountries[$dcnrw['cn_id']] = $distributor['us_id'];
			}
	}

	ss_log_message( "There is are distributors for this vendor, struct follow" );
	ss_log_message_r(  'Log:'.__FILE__.':'.__LINE__, $distributors );
	ss_log_message_r(  'Log:'.__FILE__.':'.__LINE__, $distCountries );
}


global $plist;

$plist = array();

function addStockCode( $tr, $code )
{
	global $plist;

	if( array_key_exists( "$code", $plist ) )
	{
		$plist[$code]['Boxes']++;
		if( !in_array( $tr, $plist[$code]['Transactions'] ) )
			$plist[$code]['Transactions'][] = $tr;
	}
	else
	{
		$prod = getRow( "select * from shopsystem_products join  shopsystem_product_extended_options on pro_pr_id = pr_id join shopsystem_categories on pr_ca_id = ca_id where pro_stock_code = '$code'" );
		$plist[$code] = $prod;
		$plist[$code]['Boxes'] = 1;
		$plist[$code]['Transactions'] = [$tr];
	}
}

function cmp($a, $b)
{
	if( !is_array( $a )
	 || !is_array( $b )
	 || !array_key_exists( 'pr_name', $a )
	 || !array_key_exists( 'pr_name', $b )
		)
		return;

	return strcmp( $a['pr_name'], $b['pr_name'] );
}

function dumpProductList( )
{
	global $plist;

	$TBoxes = 0;
	$TElements = 0;
	$TWeight = 0;
	$TCost = 0;

	// sort
	usort($plist, "cmp");
	ss_log_message_r(  'Log:'.__FILE__.':'.__LINE__, $plist );
	foreach( $plist as $sc=>$prod )
	{
		extract( $prod );
		if( $pro_source_currency != 'USD' )
			$pro_supplier_price *= ss_getExchangeRate( $pro_source_currency, 'USD' );
		$TBoxes += $Boxes;
		$TElements += $Boxes*$pr0_883_f;
		$TWeight += $Boxes*$pro_weight;
		$TCost += $Boxes*$pro_supplier_price;
	?>
	<tr>
		<td>
		<?php foreach( $Transactions as $tr ) echo $tr.' '; ?>
		</td>
		<td><?=$ca_name?></td>
		<td><?=$pr_name?></td>
		<td><?=$pro_stock_code?></td>
		<td><?=$pr0_883_f?></td>
		<td><?=$Boxes?></td>
		<td><?=$Boxes*$pr0_883_f?></td>
		<!--td><?=$Boxes*$pro_weight?></td-->
		<td><? echo number_format($pro_supplier_price, 2 );?></td>
		<td><? echo number_format($Boxes*$pro_supplier_price, 2 );?></td>
	</tr>
	<?php
	}
	?>
	<tr>
		<td><strong>TOTAL</strong></td>
		<td></td>
		<td></td>
		<td></td>
		<td><?=$TBoxes?></td>
		<td><?=$TElements?></td>
		<!--td><?=$TWeight?></td-->
		<td></td>
		<td><? echo number_format($TCost, 2 );?></td>
	</tr>
	<?php
}

?>

<body>
<tmpl_if condition="!array_key_exists('HideButtons',$data)">
<div class="dontPrint">
<table cellpadding=5>
	<tr>
	<input type="hidden" name="BackURL" value="{tmpl_var BackURL}">
	<td><input type="button" value="Print" onclick="window.print();"></td>
	<td>
	<input type="button" name="cancel" value="Return to List" onclick="document.location='{tmpl_var_js BackURL}';">
	</td>
	</tr>
</table>
</div>
<br />
<h1>Packing Sheet <?php echo $data['ors_id'];?></h1>
<br />
<br />
<h2><?=$title?></h2>
<br />
<br />
</tmpl_if>
<table  border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td valign="top"><table  border="0" cellspacing="0" cellpadding="20">
			<tr align="center" valign="top">
				<td colspan="2"></td>
			</tr>
			<tr align="center" valign="top">
				<td colspan="2"><table border="1" cellpadding="5" cellspacing="0" bordercolor="#CCCCCC" class="Borderinvoice">
					<tr valign="top">
						<td  align="center" class="Borderordersheet">Order</td>
						<td  align="center" class="Borderordersheet">Brand</td>
						<td  align="center" class="Borderordersheet">Description</td>
						<td  align="center" class="Borderordersheet">Stock Code</td>
						<td  align="center" class="Borderordersheet">Qty/Box</td>
						<td  align="center" class="Borderordersheet">Boxes.</td>
						<td  align="center" class="Borderordersheet">Qty.</td>
						<!---<td  align="center" class="Borderordersheet">Ordered Date</td>-->
						<!--td  align="center" class="Borderordersheet">Weight(g)</td-->
						<td  align="center" class="Borderordersheet">USD/Box</td>
						<td  align="center" class="Borderordersheet">USD</td>
				 </tr>
				 	<?php
					?>
				 	<tmpl_loop query="Q_OrderSheetItems">
						<?php

						if( $data['Distributor'] )
						{
							if( !array_key_exists( $row['or_country'], $distCountries ) )
								continue;

							if( $distCountries[$row['or_country']] != $data['Distributor'] )
								continue;
						}
						else
							if( array_key_exists( $row['or_country'], $distCountries ) )
								continue;

//						ss_log_message_r(  'Log:'.__FILE__.':'.__LINE__, $row );
						addStockCode($row['or_tr_id'], $row['orsi_stock_code']);
						?>
					</tmpl_loop>
					<?php 
					dumpProductList( );
					?>
				</table></td>
			</tr>
</table>
</body>
</html>
